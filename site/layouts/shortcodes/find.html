<input id="searchfield" onKeyUp="textupdate();" type="text" autofocus placeholder="Enter keywords to search JavaDoc, JEPs, language and VM specifications">

<p id="resultinfo">
</p>

<p id="resultfilters">
</p>

<div id="results">
</div>

<script>
"use strict";

let searchfield = document.getElementById("searchfield");
let resultinfodiv = document.getElementById("resultinfo");
let resultfiltersdiv = document.getElementById("resultfilters");
let resultsdiv = document.getElementById("results");

let debounceTimerId;
let lastSearch;
let currentQuery = ""; 
let currentFilters = new Map();; 

function textupdate() {
	clearTimeout(debounceTimerId);
	const query = searchfield.value;
	debounceTimerId = setTimeout(() => executeQuery(query, new Map(), true), 200);
}

function executeQuery(q, filter, updatehistory) {
	const search = pushParamsToURL(q, filter, updatehistory);
	if (lastSearch == search) {
		return;
	}
	lastSearch = search;
	currentQuery = q;
	currentFilters = filter;
	resultinfodiv.innerHTML = "Finding..."
	fetch('{{ $.Site.Params.Api.Find }}' + search)
		.then(response => response.json())
		.then(result => {
			renderResult(result);
		});
}

function addFilter(group, value) {
	currentFilters.set(group, value);
	executeQuery(currentQuery, currentFilters, true)
}

function removeFilter(group) {
	currentFilters.delete(group);
	executeQuery(currentQuery, currentFilters, true)
}

function tag(name, ...children) {
	const tag = document.createElement(name)
	for (const c of children) tag.append(c)
	return tag;
}

function renderResult(r) {
	resultinfodiv.innerHTML = "";
	resultinfodiv.append(r.totalhits.toLocaleString() + " total hits");
	resultfiltersdiv.innerHTML = "";
	for (const t of r.taginfos) {
		const c = tag("span", t.count.toLocaleString() + "x");
		c.className = "count";
		const s = tag("span", c, t.value);
		s.className = "tag";
		if (t.filtered) {
			s.classList.add("filtered");
			s.onclick = () => removeFilter(t.group);
		} else {
			s.onclick = () => addFilter(t.group, t.value);
		}
		s.setAttribute("title", t.group);
		resultfiltersdiv.append(s, " ");
	}
	
	resultsdiv.innerHTML = "";
	for (const h of r.hits) {
		const p = tag("p");
		
		const a = tag("a", h.title);
		a.setAttribute("href", h.url);
		p.append(a);
		
		for (const key in h.tags) {
			const s = tag("span", h.tags[key]);
			s.className = "tag";
			s.setAttribute("title", key);
			s.onclick = () => addFilter(key, h.tags[key]);
			p.append(" ", s);
		}
		
		p.append(tag("br"));
		
		if (h.more.length) {
			const s = tag("span", "â†’ Also in version ");
			s.className = "more";
			let separator = false;
			for (const m of h.more) {
				if (separator) {
					s.append(", ")
				}
				const a = tag("a", m.version);
				a.setAttribute("href", m.url);
				s.append(a);
				separator = true;
			}
			p.append(s, tag("br"));
		}
		
		const preview = tag('span');
		preview.innerHTML = h.preview;
		p.append(preview);
		
		resultsdiv.append(p);
	}
}

function pushParamsToURL(q, filter, updatehistory) {
	const url = new URL(window.location);
	url.searchParams.set('q', q);
	url.searchParams.delete('doctype');
	url.searchParams.delete('javakind');
	url.searchParams.delete('version');
	for (const [group, value] of filter.entries()) {
		url.searchParams.set(group, value);
	}
	if (updatehistory) {
		window.history.pushState({}, '', url);
	}
	return url.search;
}

function getParamsFromURL() {
	const urlParams = new URLSearchParams(window.location.search);
	if (urlParams.has('q')) {
		const q = urlParams.get('q');
		const filter = new Map();
		if (urlParams.has('doctype')) filter.set('doctype', urlParams.get('doctype'));
		if (urlParams.has('javakind')) filter.set('javakind', urlParams.get('javakind'));
		if (urlParams.has('version')) filter.set('version', urlParams.get('version'));
		searchfield.value = q;
		executeQuery(q, filter, false);
	}
}

window.addEventListener("load", (event) => getParamsFromURL());
window.addEventListener("popstate", (event) => getParamsFromURL());

</script>
